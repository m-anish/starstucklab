---
/**
 * AboutPanel.astro — Parchment panel with emblem and random variant text
 * Mobile-optimized with stacked emblem on small screens, float-wrap on desktop
 */

import aboutData from '../../public/data/about.json';
import "../styles/components/aboutpanel.css";

const about: Record<string, { title: string; lead: string; motto?: string }> = aboutData as any;
const variants = Object.keys(about || {}).sort((a, b) => {
  const an = Number(a);
  const bn = Number(b);
  if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
  return a.localeCompare(b);
});

// Pick random variant at render time
const chosen = variants.length ? variants[Math.floor(Math.random() * variants.length)] : 'default';
let content = about[chosen] || { title: '', lead: '', motto: '' };

// Sanitize text - fix mojibake and use non-breaking hyphens
const hyphenSafe = (s = '') => {
  return s
    // Fix mojibake hyphens/dashes
    .replace(/â€"|â€"|â€'|â€•/g, '-')
    // Fix curly quote mojibake
    .replace(/â€˜|â€™/g, "'")
    .replace(/â€œ|â€/g, '"')
    // Replace ASCII hyphens between letters with non-breaking hyphen (U+2011)
    .replace(/(?<=\p{L})-(?=\p{L})/gu, '\u2011');
};

content = {
  title: hyphenSafe(content.title || ''),
  lead: hyphenSafe(content.lead || ''),
  motto: content.motto ? hyphenSafe(content.motto) : undefined
};

const emblemPath = `/data/about-emblem-${chosen}.png`;
const ariaLabel = 'About Starstuck Lab';
---

<!-- Inline SVG grain filter -->
<svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden;">
  <filter id="grainFilter">
    <feTurbulence type="fractalNoise" baseFrequency="0.7" numOctaves="2" stitchTiles="stitch" result="noise"/>
    <feColorMatrix type="saturate" values="0" result="mono"/>
    <feBlend in="SourceGraphic" in2="mono" mode="overlay"/>
  </filter>
</svg>

<section class="about-panel-wrap" aria-label={ariaLabel}>
  <article id="aboutPanel" class="about-panel" data-variant={chosen}>
    <div class="grain-overlay" style="filter:url(#grainFilter)"></div>
    <div class="edge-burn" aria-hidden="true"></div>

    <div class="float-emblem" aria-hidden="true">
      <img 
        src={emblemPath}
        alt={`Emblem variant ${chosen}`}
        loading="eager"
        decoding="async"
        fetchpriority="high"
        onerror="this.onerror=null; this.style.opacity=0.65;" 
      />
    </div>

    <div class="content">
      <h2 class="title">{content.title}</h2>
      <p class="lead">{content.lead}</p>
      {content.motto ? <div class="motto">{content.motto}</div> : null}
    </div>
  </article>
</section>
